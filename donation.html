<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Donate - Sindhu Global Development Foundation</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #9c27b0;
      --accent-color: #ff7b29;
      --text-dark: #333;
      --background-white: #fff;
      --border-light: #eee;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: var(--text-dark);
      line-height: 1.6;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }

    .container {
      max-width: 900px;
      margin: 80px auto 40px auto;
      background: var(--background-white);
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      padding: 30px;
    }

    .nav-tabs {
      border-bottom: 2px solid var(--border-light);
      margin-bottom: 20px;
    }

    .nav-tabs .nav-link {
      color: var(--text-dark);
      font-weight: 600;
      font-size: 1.1rem;
      padding: 10px 20px;
      border: none;
      border-bottom: 3px solid transparent;
      transition: all 0.3s ease;
    }

    .nav-tabs .nav-link:hover {
      color: var(--accent-color);
      border-bottom: 3px solid var(--accent-color);
    }

    .nav-tabs .nav-link.active {
      color: var(--accent-color);
      border-bottom: 3px solid var(--accent-color);
      background: none;
    }

    .tab-content {
      padding: 20px 0;
    }

    .donate-info h2 {
      color: var(--accent-color);
      font-size: 1.8rem;
      font-weight: 700;
      margin-bottom: 20px;
    }

    .donate-info p {
      color: #555;
      margin-bottom: 15px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-label {
      color: #444;
      font-weight: 600;
      font-size: 0.95rem;
      margin-bottom: 8px;
      display: block;
    }

    .form-control, .form-select {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid var(--border-light);
      border-radius: 8px;
      font-size: 0.95rem;
      transition: all 0.2s ease;
    }

    .form-control:focus, .form-select:focus {
      border-color: var(--accent-color);
      box-shadow: 0 0 0 3px rgba(255, 123, 41, 0.1);
      outline: none;
    }

    .form-control.is-invalid {
      border-color: #dc3545;
    }

    .invalid-feedback {
      color: #dc3545;
      font-size: 0.85rem;
      margin-top: 5px;
      display: none;
    }

    .form-control.is-invalid ~ .invalid-feedback,
    .form-select.is-invalid ~ .invalid-feedback {
      display: block;
    }

    .form-select {
      appearance: none;
      background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23333' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E") no-repeat right 12px center;
    }

    .donation-details {
      background: var(--background-white);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.05);
    }

    .donation-details h3 {
      color: var(--text-dark);
      font-size: 1.4rem;
      font-weight: 600;
      margin-bottom: 20px;
    }

    .btn-pay, .btn-submit {
      width: 100%;
      padding: 15px;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-pay {
      background: #007bff;
    }

    .btn-pay:hover {
      background: #0056b3;
      transform: translateY(-2px);
    }

    .btn-submit {
      background: #28a745;
    }

    .btn-submit:hover {
      background: #218838;
      transform: translateY(-2px);
    }

    .payment-options {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
    }

    .payment-options img {
      height: 20px;
    }

    .terms {
      color: #6c757d;
      font-size: 0.85rem;
      margin-top: 15px;
      text-align: center;
    }

    .queries-section {
      text-align: center;
      padding: 15px;
      background: #f8f9fa;
      border: 1px solid var(--border-light);
      border-radius: 8px;
      margin: 20px 0;
    }

    .queries-section h4 {
      color: var(--accent-color);
      font-size: 1.2rem;
      margin-bottom: 10px;
    }

    .queries-section p {
      font-size: 0.9rem;
      color: #555;
      margin-bottom: 8px;
    }

    .queries-section a {
      color: var(--accent-color);
      text-decoration: none;
    }

    .queries-section a:hover {
      text-decoration: underline;
    }

    .modal-content {
      border-radius: 12px;
      text-align: center;
      padding: 30px;
    }

    .modal-header {
      border-bottom: none;
      padding: 0;
    }

    .modal-title {
      font-size: 1.5rem;
      color: #28a745;
      font-weight: 700;
    }

    .modal-body p {
      font-size: 1rem;
      color: var(--text-dark);
      margin-bottom: 20px;
    }

    #otherItemContainer {
      display: none;
      margin-top: 10px;
    }

    @media (max-width: 768px) {
      .container {
        margin: 70px auto 30px auto;
        padding: 20px;
      }

      .donation-details {
        padding: 15px;
      }

      .queries-section {
        padding: 10px;
      }

      .nav-tabs .nav-link {
        font-size: 1rem;
        padding: 8px 15px;
      }
    }
  </style>
</head>
<body>
  <!-- Include Navbar -->
  <div id="navbar"></div>

  <div class="container">
    <div class="donate-info">
      <h2>Make a Difference</h2>
      <p>Support our mission to empower underprivileged!</p>
    </div>

    <!-- Tab Navigation -->
    <ul class="nav nav-tabs" id="donationTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="money-tab" data-bs-toggle="tab" data-bs-target="#money" type="button" role="tab" aria-controls="money" aria-selected="true" onclick="setDonationType('money')">Money</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="inKind-tab" data-bs-toggle="tab" data-bs-target="#inKind" type="button" role="tab" aria-controls="inKind" aria-selected="false" onclick="setDonationType('inKind')">In-Kind</button>
      </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="donationTabContent">
      <div class="tab-pane fade show active" id="money" role="tabpanel" aria-labelledby="money-tab">
        <div class="donation-details">
          <h3>Donation Details</h3>
          <div id="standardFields">
            <div class="form-group">
              <label for="firstName" class="form-label">First Name *</label>
              <input type="text" class="form-control" id="firstName" required>
              <div class="invalid-feedback">First name must be at least 2 characters long and contain only letters.</div>
            </div>
            <div class="form-group">
              <label for="lastName" class="form-label">Last Name *</label>
              <input type="text" class="form-control" id="lastName" required>
              <div class="invalid-feedback">Last name must be at least 2 characters long and contain only letters.</div>
            </div>
            <div class="form-group">
              <label for="email" class="form-label">Email *</label>
              <input type="email" class="form-control" id="email" required>
              <div class="invalid-feedback">Please enter a valid email address.</div>
            </div>
            <div class="form-group">
              <label for="address" class="form-label">Address *</label>
              <input type="text" class="form-control" id="address" required>
              <div class="invalid-feedback">Address must be at least 5 characters long.</div>
            </div>
            <div class="form-group">
              <label for="panNo" class="form-label">PAN No. *</label>
              <input type="text" class="form-control" id="panNo" required>
              <div class="invalid-feedback">Please enter a valid PAN number (e.g., ABCDE1234F).</div>
            </div>
          </div>
          <div class="form-group" id="subOptionContainer">
            <label for="subOption" class="form-label">Select Sub-Option *</label>
            <select class="form-select" id="subOption" onchange="updateDetails()" required>
              <option value="">-Select-</option>
            </select>
            <div class="invalid-feedback">Please select a sub-option.</div>
          </div>
          <div class="form-group" id="otherItemContainer" style="display: none;">
            <label for="otherItem" class="form-label">Other Item (Optional)</label>
            <input type="text" class="form-control" id="otherItem" placeholder="Enter custom item if 'Other' is selected">
            <div class="invalid-feedback">Custom item must be at least 3 characters long.</div>
          </div>
          <div id="dynamicFields"></div>
          <div id="donationTypeDisplay" class="form-group" style="display: none;">
            <label class="form-label">Donation Type:</label>
            <p id="selectedType" style="margin: 0;"></p>
          </div>
          <button type="button" class="btn-pay" id="payButton" style="display: none;" onclick="handleOnlinePayment()">Pay Amount <span id="displayAmount">0.00</span></button>
          <button type="button" class="btn-submit" id="submitButton" style="display: none;" onclick="handleSubmission()">Submit</button>
          <div class="payment-options" style="display: none;" id="paymentOptions">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/1b/UPI-Logo.svg/1200px-UPI-Logo.svg.png" alt="UPI">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/5e/Visa_Inc._logo.svg/200px-Visa_Inc._logo.svg.png" alt="Visa">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/1a/MasterCard_2019_logo.svg/1200px-MasterCard_ 2019_logo.svg.png" alt="MasterCard">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/b/b8/RuPay_Logo.svg/1200px-RuPay_Logo.svg.png" alt="RuPay">
          </div>
        </div>
      </div>
      <div class="tab-pane fade" id="inKind" role="tabpanel" aria-labelledby="inKind-tab">
        <div class="donation-details">
          <h3>Donation Details</h3>
          <div id="standardFieldsInKind">
            <div class="form-group">
              <label for="firstName" class="form-label">First Name *</label>
              <input type="text" class="form-control" id="firstName" required>
              <div class="invalid-feedback">First name must be at least 2 characters long and contain only letters.</div>
            </div>
            <div class="form-group">
              <label for="lastName" class="form-label">Last Name *</label>
              <input type="text" class="form-control" id="lastName" required>
              <div class="invalid-feedback">Last name must be at least 2 characters long and contain only letters.</div>
            </div>
            <div class="form-group">
              <label for="email" class="form-label">Email *</label>
              <input type="email" class="form-control" id="email" required>
              <div class="invalid-feedback">Please enter a valid email address.</div>
            </div>
            <div class="form-group">
              <label for="address" class="form-label">Address *</label>
              <input type="text" class="form-control" id="address" required>
              <div class="invalid-feedback">Address must be at least 5 characters long.</div>
            </div>
            <div class="form-group">
              <label for="panNo" class="form-label">PAN No. *</label>
              <input type="text" class="form-control" id="panNo" required>
              <div class="invalid-feedback">Please enter a valid PAN number (e.g., ABCDE1234F).</div>
            </div>
          </div>
          <div class="form-group" id="subOptionContainerInKind">
            <label for="subOption" class="form-label">Select Sub-Option *</label>
            <select class="form-select" id="subOption" onchange="updateDetails()" required>
              <option value="">-Select-</option>
            </select>
            <div class="invalid-feedback">Please select a sub-option.</div>
          </div>
          <div class="form-group" id="otherItemContainerInKind" style="display: none;">
            <label for="otherItem" class="form-label">Other Item (Optional)</label>
            <input type="text" class="form-control" id="otherItem" placeholder="Enter custom item if 'Other' is selected">
            <div class="invalid-feedback">Custom item must be at least 3 characters long.</div>
          </div>
          <div id="dynamicFieldsInKind"></div>
          <div id="donationTypeDisplayInKind" class="form-group" style="display: none;">
            <label class="form-label">Donation Type:</label>
            <p id="selectedType" style="margin: 0;"></p>
          </div>
          <button type="button" class="btn-pay" id="payButtonInKind" style="display: none;" onclick="handleOnlinePayment()">Pay Amount <span id="displayAmountInKind">0.00</span></button>
          <button type="button" class="btn-submit" id="submitButtonInKind" style="display: none;" onclick="handleSubmission()">Submit</button>
          <div class="payment-options" style="display: none;" id="paymentOptionsInKind">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/1b/UPI-Logo.svg/1200px-UPI-Logo.svg.png" alt="UPI">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/5e/Visa_Inc._logo.svg/200px-Visa_Inc._logo.svg.png" alt="Visa">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/1a/MasterCard_2019_logo.svg/1200px-MasterCard_2019_logo.svg.png" alt="MasterCard">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/b/b8/RuPay_Logo.svg/1200px-RuPay_Logo.svg.png" alt="RuPay">
          </div>
        </div>
      </div>
    </div>

    <!-- Queries and Terms Section -->
    <div class="queries-section">
      <h4>In Case of Queries</h4>
      <p>Phone: <a href="tel:+917021668519">+91 7021668519 (Haresh Rupani)</a></p>
      <p>Phone: <a href="tel:+919371262700">+91 9371262700 (CA Hari Dudani)</a></p>
      <p>Email: <a href="mailto:sindhuglobal.df@gmail.com">sindhuglobal.df@gmail.com</a></p>
    </div>
    <div class="terms">
      Terms & Conditions: You agree to share information entered on this page with Sindhu Global Development Foundation (owner of this page) and Razorpay, adhering to applicable laws.
    </div>
  </div>

  <!-- Include Footer -->
  <div id="footer"></div>

  <!-- Thank You Modal -->
  <div class="modal fade" id="thankYouModal" tabindex="-1" aria-labelledby="thankYouModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="thankYouModalLabel">Thank You!</h5>
        </div>
        <div class="modal-body">
          <p>Thank you for your generous donation. Your support makes a difference!</p>
          <p>Login credentials for accessing Donor Dashboard have been sent via email.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK (Compatibility Mode) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Declare variables at the top to avoid TDZ
    let selectedType = 'money';
    let selectedSubOption = '';
    let isOnlineProcessed = false;

    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDkLmo4Vf-1U8Vl_grn2waMigYCyMj1BaU",
      authDomain: "formtestsgft.firebaseapp.com",
      databaseURL: "https://formtestsgft-default-rtdb.firebaseio.com",
      projectId: "formtestsgft",
      storageBucket: "formtestsgft.appspot.com",
      messagingSenderId: "688396867961",
      appId: "1:688396867961:web:099be0b0c1a3f81e4f77a8"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Load navbar and footer
    fetch('navbar.html')
      .then(response => response.text())
      .then(data => {
        document.getElementById('navbar').innerHTML = data;
        // Highlight active navbar link
        const currentPage = window.location.pathname.split('/').pop() || 'index.html';
        document.querySelectorAll('nav a').forEach(link => {
          link.classList.remove('active');
          const href = link.getAttribute('href');
          if (href === currentPage) {
            link.classList.add('active');
          }
        });
        // Update UI based on login state
        updateUIForLoginState(getCookie('isLoggedIn') === 'true');
        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
          logoutBtn.addEventListener('click', handleLogout);
        }
      })
      .catch(error => console.error('Error fetching navbar:', error));

    fetch('footer.html')
      .then(response => response.text())
      .then(data => {
        document.getElementById('footer').innerHTML = data;
      })
      .catch(error => console.error('Error fetching footer:', error));

    // Cookie management functions
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
      return null;
    }

    function setCookie(name, value, days) {
      let expires = "";
      if (days) {
        const date = new Date();
        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
        expires = "; expires=" + date.toUTCString();
      }
      document.cookie = name + "=" + (value || "") + expires + "; path=/";
    }

    function deleteCookie(name) {
      document.cookie = name + '=; Max-Age=0; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT';
    }

    function updateUIForLoginState(isLoggedIn) {
      const signInBtn = document.querySelector('.btn-signin');
      const logoutBtn = document.getElementById('logoutBtn');

      if (isLoggedIn) {
        if (signInBtn) signInBtn.style.display = 'none';
        if (logoutBtn) logoutBtn.style.display = 'inline-block';
      } else {
        if (signInBtn) signInBtn.style.display = 'inline-block';
        if (logoutBtn) logoutBtn.style.display = 'none';
      }
    }

    function handleLogout() {
      deleteCookie('isLoggedIn');
      deleteCookie('userEmail');
      updateUIForLoginState(false);
      window.location.href = 'index.html';
    }

    // Authentication iframe
    window.loadAuthIframe = function() {
      const iframe = document.createElement('iframe');
      iframe.src = 'authh.html';
      iframe.width = '100%';
      iframe.height = '600px';
      iframe.frameBorder = '0';
      iframe.style.border = 'none';

      const container = document.getElementById('iframe-container');
      const blurOverlay = document.getElementById('blur-overlay');

      if (container && blurOverlay) {
        container.innerHTML = '';
        container.appendChild(iframe);
        blurOverlay.classList.add('active');
        container.classList.add('active');

        window.addEventListener('message', function handler(event) {
          if (event.data === 'loginSuccess') {
            setCookie('isLoggedIn', 'true', 7);
            blurOverlay.classList.remove('active');
            container.classList.remove('active');
            setTimeout(() => {
              container.innerHTML = '';
              window.location.href = 'userDash.html';
            }, 300);
            window.removeEventListener('message', handler);
          }
        });
      } else {
        console.error("Container or blur overlay not found");
      }
    };

    // Simple encryption for password (base64 for simplicity)
    function encryptPassword(password) {
      return btoa(password);
    }

    function validateField(field, validationFn, errorMessage) {
      const isValid = validationFn(field.value.trim());
      field.classList.toggle('is-invalid', !isValid);
      const feedback = field.nextElementSibling;
      if (feedback && feedback.classList.contains('invalid-feedback')) {
        feedback.textContent = isValid ? '' : errorMessage;
      }
      return isValid;
    }

    function validateForm() {
      let isValid = true;
      const activeTab = document.querySelector('.tab-pane.active');
      const firstName = activeTab.querySelector('#firstName');
      const lastName = activeTab.querySelector('#lastName');
      const email = activeTab.querySelector('#email');
      const address = activeTab.querySelector('#address');
      const panNo = activeTab.querySelector('#panNo');
      const subOption = activeTab.querySelector('#subOption');
      const otherItem = activeTab.querySelector('#otherItem');
      const donationAmount = activeTab.querySelector('#donationAmount');
      const itemDetails = activeTab.querySelector('#itemDetails');
      const submissionType = activeTab.querySelector('#submissionType');
      const submissionDate = activeTab.querySelector('#submissionDate');

      // Standard fields
      isValid &= validateField(firstName, value => /^[a-zA-Z]{2,}$/.test(value), 'First name must be at least 2 characters long and contain only letters.');
      isValid &= validateField(lastName, value => /^[a-zA-Z]{2,}$/.test(value), 'Last name must be at least 2 characters long and contain only letters.');
      isValid &= validateField(email, value => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value), 'Please enter a valid email address.');
      isValid &= validateField(address, value => value.length >= 5, 'Address must be at least 5 characters long.');
      isValid &= validateField(panNo, value => /^[A-Z]{5}[0-9]{4}[A-Z]$/.test(value), 'Please enter a valid PAN number (e.g., ABCDE1234F).');

      // Sub-option
      if (activeTab.querySelector('#subOptionContainer').style.display !== 'none') {
        isValid &= validateField(subOption, value => value !== '', 'Please select a sub-option.');
      }

      // Other item (optional, but validated if provided)
      if (otherItem && activeTab.querySelector('#otherItemContainer').style.display !== 'none' && otherItem.value.trim()) {
        isValid &= validateField(otherItem, value => value.length >= 3, 'Custom item must be at least 3 characters long.');
      }

      // Dynamic fields
      if (selectedType === 'money' && donationAmount) {
        isValid &= validateField(donationAmount, value => value >= 100 && !isNaN(value), 'Donation amount must be at least ₹100.');
        if (selectedSubOption !== 'online') {
          if (submissionType) {
            isValid &= validateField(submissionType, value => value !== '', 'Please select a submission type.');
          }
          if (submissionDate && activeTab.querySelector('#submissionDateContainer').style.display !== 'none') {
            const today = new Date().setHours(0, 0, 0, 0);
            const selectedDate = new Date(submissionDate.value).setHours(0, 0, 0, 0);
            isValid &= validateField(submissionDate, value => value && selectedDate >= today, 'Please select a future date.');
          }
        }
      } else if (selectedType === 'inKind' && itemDetails) {
        isValid &= validateField(itemDetails, value => value.length >= 5, 'Item details must be at least 5 characters long.');
        if (submissionType) {
          isValid &= validateField(submissionType, value => value !== '', 'Please select a submission type.');
        }
        if (submissionDate && activeTab.querySelector('#submissionDateContainer').style.display !== 'none') {
          const today = new Date().setHours(0, 0, 0, 0);
          const selectedDate = new Date(submissionDate.value).setHours(0, 0, 0, 0);
          isValid &= validateField(submissionDate, value => value && selectedDate >= today, 'Please select a future date.');
        }
      }

      return isValid;
    }

    function setDonationType(type) {
      selectedType = type;
      const subOptionSelect = document.querySelector(`#${type} #subOption`);
      const subOptionContainer = document.querySelector(`#${type} #subOptionContainer`);
      const donationTypeDisplay = document.querySelector(`#${type} #donationTypeDisplay`);
      const selectedTypeElement = document.querySelector(`#${type} #selectedType`);

      subOptionSelect.innerHTML = '<option value="">-Select-</option>';
      donationTypeDisplay.style.display = 'none';
      document.querySelector(`#${type} #dynamicFields`).innerHTML = '';
      document.querySelector(`#${type} #payButton`).style.display = 'none';
      document.querySelector(`#${type} #submitButton`).style.display = 'none';
      document.querySelector(`#${type} #paymentOptions`).style.display = 'none';
      isOnlineProcessed = false;
      document.querySelector(`#${type} #otherItemContainer`).style.display = 'none';

      subOptionContainer.style.display = 'block';
      selectedTypeElement.textContent = type.charAt(0).toUpperCase() + type.slice(1).replace(/([A-Z])/g, ' $1');
      donationTypeDisplay.style.display = 'block';
      if (type === 'money') {
        const options = ['cash', 'cheque', 'online'];
        options.forEach(option => {
          const optionText = option.charAt(0).toUpperCase() + option.slice(1).replace(/([A-Z])/g, ' $1');
          subOptionSelect.innerHTML += `<option value="${option}">${optionText}</option>`;
        });
      } else if (type === 'inKind') {
        db.ref('inkindItems').once('value', (snapshot) => {
          subOptionSelect.innerHTML = '<option value="">-Select-</option>';
          snapshot.forEach(childSnapshot => {
            const item = childSnapshot.val();
            const optionText = item.charAt(0).toUpperCase() + item.slice(1).replace(/([A-Z])/g, ' $1');
            subOptionSelect.innerHTML += `<option value="${item}">${optionText}</option>`;
          });
          subOptionSelect.innerHTML += '<option value="other">Other</option>';
        }).catch(error => console.error('Error fetching in-kind items:', error));
      }
    }

    function updateDetails() {
      const activeTab = document.querySelector('.tab-pane.active').id;
      const subOption = document.querySelector(`#${activeTab} #subOption`).value;
      const dynamicFields = document.querySelector(`#${activeTab} #dynamicFields`);
      const payButton = document.querySelector(`#${activeTab} #payButton`);
      const submitButton = document.querySelector(`#${activeTab} #submitButton`);
      const paymentOptions = document.querySelector(`#${activeTab} #paymentOptions`);

      dynamicFields.innerHTML = '';
      payButton.style.display = 'none';
      submitButton.style.display = 'none';
      paymentOptions.style.display = 'none';
      isOnlineProcessed = false;

      if (subOption) {
        selectedSubOption = subOption;
        if (selectedType === 'money') {
          dynamicFields.innerHTML = `
            <div class="form-group">
              <label for="donationAmount" class="form-label">Donation Amount (₹) *</label>
              <input type="number" class="form-control" id="donationAmount" min="100" required>
              <div class="invalid-feedback">Donation amount must be at least ₹100.</div>
            </div>
          `;
          if (subOption === 'online') {
            payButton.style.display = 'block';
            paymentOptions.style.display = 'flex';
            updatePayButtonText();
            document.querySelector(`#${activeTab} #donationAmount`).addEventListener('input', updatePayButtonText);
          } else {
            dynamicFields.innerHTML += `
              <div class="form-group">
                <label for="submissionType" class="form-label">Submission Type *</label>
                <select class="form-select" id="submissionType" onchange="toggleSubmissionDate()" required>
                  <option value="">-Select-</option>
                  <option value="ngo">Submit to NGO</option>
                  <option value="collect">Needs to be Collected</option>
                </select>
                <div class="invalid-feedback">Please select a submission type.</div>
              </div>
              <div class="form-group" id="submissionDateContainer" style="display: none;">
                <label for="submissionDate" class="form-label">Submission/Collection Date *</label>
                <input type="date" class="form-control" id="submissionDate" required>
                <div class="invalid-feedback">Please select a future date.</div>
              </div>
            `;
            submitButton.style.display = 'block';
          }
        } else if (selectedType === 'inKind') {
          dynamicFields.innerHTML = `
            <div class="form-group">
              <label for="itemDetails" class="form-label">Item Details *</label>
              <input type="text" class="form-control" id="itemDetails" placeholder="Describe the items" required>
              <div class="invalid-feedback">Item details must be at least 5 characters long.</div>
            </div>
            <div class="form-group">
              <label for="submissionType" class="form-label">Submission Type *</label>
              <select class="form-select" id="submissionType" onchange="toggleSubmissionDate()" required>
                <option value="">-Select-</option>
                <option value="ngo">Submit to NGO</option>
                <option value="collect">Needs to be Collected</option>
              </select>
              <div class="invalid-feedback">Please select a submission type.</div>
            </div>
            <div class="form-group" id="submissionDateContainer" style="display: none;">
              <label for="submissionDate" class="form-label">Submission/Collection Date *</label>
              <input type="date" class="form-control" id="submissionDate" required>
              <div class="invalid-feedback">Please select a future date.</div>
            </div>
          `;
          submitButton.style.display = 'block';
        }
      }

      // Toggle other item field for inKind tab
      if (selectedType === 'inKind' && subOption === 'other') {
        document.querySelector(`#${activeTab} #otherItemContainer`).style.display = 'block';
      } else {
        document.querySelector(`#${activeTab} #otherItemContainer`).style.display = 'none';
        document.querySelector(`#${activeTab} #otherItem`).value = '';
      }
    }

    function toggleSubmissionDate() {
      const activeTab = document.querySelector('.tab-pane.active').id;
      const submissionType = document.querySelector(`#${activeTab} #submissionType`)?.value;
      const submissionDateContainer = document.querySelector(`#${activeTab} #submissionDateContainer`);
      if (submissionType === 'ngo' || submissionType === 'collect') {
        submissionDateContainer.style.display = 'block';
      } else {
        submissionDateContainer.style.display = 'none';
        document.querySelector(`#${activeTab} #submissionDate`).value = '';
      }
    }

    function updatePayButtonText() {
      const activeTab = document.querySelector('.tab-pane.active').id;
      const amount = document.querySelector(`#${activeTab} #donationAmount`).value || 0;
      const payButton = document.querySelector(`#${activeTab} #payButton`);
      payButton.textContent = `Pay ₹${amount}.00`;
    }

    function handleOnlinePayment() {
      if (!validateForm()) {
        alert('Please correct the errors in the form.');
        return;
      }
      const activeTab = document.querySelector('.tab-pane.active').id;
      const amount = document.querySelector(`#${activeTab} #donationAmount`)?.value.trim();
      if (!amount || amount < 100) {
        alert('Please enter a valid donation amount of at least ₹100.');
        return;
      }
      alert('Payment processing via gateway');
      isOnlineProcessed = true;
      document.querySelector(`#${activeTab} #payButton`).style.display = 'none';
      document.querySelector(`#${activeTab} #submitButton`).style.display = 'block';
    }

    function handleSubmission() {
      if (!validateForm()) {
        alert('Please correct the errors in the form.');
        return;
      }

      const activeTab = document.querySelector('.tab-pane.active').id;
      const firstName = document.querySelector(`#${activeTab} #firstName`).value.trim();
      const lastName = document.querySelector(`#${activeTab} #lastName`).value.trim();
      const email = document.querySelector(`#${activeTab} #email`).value.trim();
      const address = document.querySelector(`#${activeTab} #address`).value.trim();
      const panNo = document.querySelector(`#${activeTab} #panNo`).value.trim();
      let amountOrItem = '';
      let submissionType = '';
      let submissionDate = '';
      let otherItem = document.querySelector(`#${activeTab} #otherItem`)?.value.trim();

      if (selectedType === 'money') {
        amountOrItem = document.querySelector(`#${activeTab} #donationAmount`).value.trim();
        if (!amountOrItem || amountOrItem < 100) {
          alert('Please enter a valid donation amount of at least ₹100.');
          return;
        }
        if (selectedSubOption !== 'online' || isOnlineProcessed) {
          submissionType = document.querySelector(`#${activeTab} #submissionType`)?.value;
          if (!submissionType && selectedSubOption !== 'online') {
            alert('Please select a submission type.');
            return;
          }
          if (submissionType && (submissionType === 'ngo' || submissionType === 'collect')) {
            submissionDate = document.querySelector(`#${activeTab} #submissionDate`)?.value;
            if (!submissionDate) {
              alert('Please select a submission/collection date.');
              return;
            }
          }
          alert(`Thank you ${firstName}! Your ${selectedSubOption} donation of ₹${amountOrItem} shall be ${submissionType === 'ngo' ? 'submitted by you to NGO' : 'collected'} on ${submissionDate || 'a communicated date and time'}.`);
        }
      } else if (selectedType === 'inKind') {
        amountOrItem = document.querySelector(`#${activeTab} #itemDetails`)?.value.trim();
        submissionType = document.querySelector(`#${activeTab} #submissionType`)?.value;
        if (!amountOrItem || !submissionType) {
          alert('Please fill in all required fields for in-kind donation.');
          return;
        }
        if (submissionType === 'ngo' || submissionType === 'collect') {
          submissionDate = document.querySelector(`#${activeTab} #submissionDate`)?.value;
          if (!submissionDate) {
            alert('Please select a submission/collection date.');
            return;
          }
        }
        if (selectedSubOption === 'other' && otherItem && otherItem.length < 3) {
          alert('Custom item must be at least 3 characters long if provided.');
          return;
        }
        amountOrItem = otherItem ? `${amountOrItem} (${otherItem})` : amountOrItem;
        alert(`Thank you ${firstName}! Your in-kind donation of ${amountOrItem} will be ${submissionType === 'ngo' ? 'submitted to NGO' : 'collected'} on ${submissionDate}.`);
      }

      // Save to Firebase Realtime Database
      try {
        const sanitizedEmail = email.replace(/\./g, '_');
        const donationRef = db.ref(`donations/${sanitizedEmail}`).push();
        donationRef.set({
          firstName,
          lastName,
          email,
          address,
          panNo,
          donationType: selectedType,
          subOption: selectedSubOption,
          amountOrItem,
          submissionType: submissionType || 'online',
          submissionDate: submissionDate ? new Date(submissionDate).getTime() : null,
          timestamp: firebase.database.ServerValue.TIMESTAMP
        }).then(() => {
          // Generate and store credentials in userCreds node
          const password = `${firstName.toUpperCase()}@${panNo.slice(0, 4).toUpperCase()}`;
          return db.ref(`userCreds/${sanitizedEmail}`).set({
            email,
            password: encryptPassword(password),
            firstName,
            lastName,
            timestamp: firebase.database.ServerValue.TIMESTAMP
          }).catch(error => {
            console.error('Error saving credentials:', error);
            throw new Error('Error saving credentials');
          });
        }).then(() => {
          if (selectedType === 'inKind' && selectedSubOption === 'other' && otherItem) {
            return db.ref('otherItems').push({
              item: otherItem,
              donationId: donationRef.key,
              pendingApproval: true,
              timestamp: firebase.database.ServerValue.TIMESTAMP
            }).catch(error => {
              console.error('Error saving other item:', error);
              throw new Error('Error saving other item');
            });
          }
        }).then(() => {
          // Show the thank you modal
          const modal = new bootstrap.Modal(document.getElementById('thankYouModal'));
          modal.show();

          // Show "Donation recorded" alert only after modal is hidden
          document.getElementById('thankYouModal').addEventListener('hidden.bs.modal', function handler() {
            alert('Donation recorded');
            // Clear form fields in active tab
            document.querySelectorAll(`#${activeTab} .form-control, #${activeTab} .form-select`).forEach(input => {
              input.value = '';
              input.classList.remove('is-invalid');
            });
            document.querySelector(`#${activeTab} #displayAmount`).textContent = '0.00';
            document.querySelector(`#${activeTab} #subOption`).value = '';
            document.querySelector(`#${activeTab} #otherItemContainer`).style.display = 'none';
            document.querySelector(`#${activeTab} #submissionDateContainer`).style.display = 'none';
            setDonationType(selectedType);
            this.removeEventListener('hidden.bs.modal', handler);
          }, { once: true });
        }).catch(error => {
          console.error('Error saving donation:', error);
          alert('An error occurred while submitting your donation. Please try again.');
        });
      } catch (error) {
        console.error('Error saving donation:', error);
        alert('An error occurred while submitting your donation. Please try again.');
      }
    }

    window.onload = function() {
      // Initialize login state
      updateUIForLoginState(getCookie('isLoggedIn') === 'true');

      // Add real-time validation listeners
      const tabs = ['money', 'inKind'];
      tabs.forEach(tab => {
        const fields = ['firstName', 'lastName', 'email', 'address', 'panNo', 'subOption'];
        fields.forEach(id => {
          const field = document.querySelector(`#${tab} #${id}`);
          if (field) {
            field.addEventListener('input', () => validateField(field, getValidationFn(id), getErrorMessage(id)));
          }
        });
        document.querySelector(`#${tab}`).addEventListener('change', (e) => {
          if (e.target.id === 'submissionType') {
            validateField(e.target, value => value !== '', 'Please select a submission type.');
          }
        });
      });

      // Initialize the default tab
      setDonationType('money');
    };

    function getValidationFn(id) {
      switch (id) {
        case 'firstName': return value => /^[a-zA-Z]{2,}$/.test(value);
        case 'lastName': return value => /^[a-zA-Z]{2,}$/.test(value);
        case 'email': return value => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value);
        case 'address': return value => value.length >= 5;
        case 'panNo': return value => /^[A-Z]{5}[0-9]{4}[A-Z]$/.test(value);
        case 'subOption': return value => value !== '';
        default: return () => true;
      }
    }

    function getErrorMessage(id) {
      switch (id) {
        case 'firstName': return 'First name must be at least 2 characters long and contain only letters.';
        case 'lastName': return 'Last name must be at least 2 characters long and contain only letters.';
        case 'email': return 'Please enter a valid email address.';
        case 'address': return 'Address must be at least 5 characters long.';
        case 'panNo': return 'Please enter a valid PAN number (e.g., ABCDE1234F).';
        case 'subOption': return 'Please select a sub-option.';
        default: return '';
      }
    }

    window.addEventListener('message', (event) => {
      if (event.data === 'closePopup') {
        window.parent.closeDonatePopup();
      }
    });
  </script>
</body>
</html>